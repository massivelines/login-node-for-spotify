<!DOCTYPE html>
<html>

<head>
  <title>Callback</title>
  <script>
    // After user logins into Spotify, Spotify redirects the popup to a set <url>/callback
    // this popup intercepts it and procces the url for information Spotify sent back
    (function() {
      // TODO add security for injected url regex

      // gets web address of called windows location/node server
      var nodeHost = window.location.origin;

      // splits the url to set infrom into the object data{code: , state:}
      var urlSplit = window.location.href.split('?');
      urlSplit = urlSplit[1].split('&');
      var data = {};
      for (var i = 0; i < urlSplit.length; i++) {
        if (urlSplit[i].indexOf('=') > 0) {
          var split = urlSplit[i].split('=');
          data[split[0]] = split[1];
        }
      }

      // if data has code: then send it to node server /callback
      if (data.code) {
        fetch(nodeHost + '/callback', {
          method: 'POST',
          body: JSON.stringify(data),
          headers: {
            'Content-Type': 'application/json'
          }
        }).then(function(response) {
          if (response.status == 200) {
            window.close();
          }
        }).catch(function(err) {
          // Error :(
          // TODO error data screen relogin
          console.log(err);
          console.log('error');
        });
      } else {
        // TODO: error
      }
    })();

    // TODO: loading screen?
  </script>
</head>

<body>
</body>

</html>
